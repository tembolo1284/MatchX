name: ME_SERVER CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'me_server/**'
      - '.github/workflows/server-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'me_server/**'
      - '.github/workflows/server-ci.yml'

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential wget
    
    - name: Install Premake5
      run: |
        wget https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-linux.tar.gz
        tar -xzf premake-5.0.0-beta2-linux.tar.gz
        sudo mv premake5 /usr/local/bin/
        premake5 --version
    
    - name: Build me_lib (dependency)
      working-directory: me_lib
      run: |
        premake5 gmake2
        make config=release
    
    - name: Generate build files
      working-directory: me_server
      run: premake5 gmake2
    
    - name: Build me_server
      working-directory: me_server
      run: make config=release verbose=1
    
    - name: Verify executables
      working-directory: me_server
      run: |
        ls -lh bin/Release-linux-x86_64/Engine/matching_engine
        ls -lh bin/Release-linux-x86_64/Gateway/gateway_server
        ls -lh bin/Release-linux-x86_64/TradingClient/trading_client
        file bin/Release-linux-x86_64/Engine/matching_engine
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: me_server-linux-x64
        path: |
          me_server/bin/Release-linux-x86_64/Engine/matching_engine
          me_server/bin/Release-linux-x86_64/Gateway/gateway_server
          me_server/bin/Release-linux-x86_64/TradingClient/trading_client
        retention-days: 30

  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Install Premake5
      run: |
        brew install premake
        premake5 --version
    
    - name: Build me_lib (dependency)
      working-directory: me_lib
      run: |
        premake5 gmake2
        make config=release
    
    - name: Generate build files
      working-directory: me_server
      run: premake5 gmake2
    
    - name: Build me_server
      working-directory: me_server
      run: make config=release
    
    - name: Verify executables
      working-directory: me_server
      run: |
        ls -lh bin/Release-macosx-x86_64/Engine/matching_engine
        ls -lh bin/Release-macosx-x86_64/Gateway/gateway_server
        ls -lh bin/Release-macosx-x86_64/TradingClient/trading_client
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: me_server-macos-x64
        path: |
          me_server/bin/Release-macosx-x86_64/Engine/matching_engine
          me_server/bin/Release-macosx-x86_64/Gateway/gateway_server
          me_server/bin/Release-macosx-x86_64/TradingClient/trading_client
        retention-days: 30

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install clang-format
      run: sudo apt-get install -y clang-format
    
    - name: Check code formatting
      working-directory: me_server
      run: |
        find . -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror
    
    - name: Count lines of code
      working-directory: me_server
      run: |
        echo "=== Lines of Code ==="
        find . -name "*.cpp" -o -name "*.h" | xargs wc -l | tail -1

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: build-linux
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: me_server-linux-x64
        path: me_server/bin/Release-linux-x86_64/
    
    - name: Set executable permissions
      working-directory: me_server
      run: |
        chmod +x bin/Release-linux-x86_64/Engine/matching_engine
        chmod +x bin/Release-linux-x86_64/Gateway/gateway_server
        chmod +x bin/Release-linux-x86_64/TradingClient/trading_client
    
    - name: Start matching engine
      working-directory: me_server
      run: |
        ./bin/Release-linux-x86_64/Engine/matching_engine &
        ENGINE_PID=$!
        echo "ENGINE_PID=$ENGINE_PID" >> $GITHUB_ENV
        sleep 2
    
    - name: Start gateway
      working-directory: me_server
      run: |
        ./bin/Release-linux-x86_64/Gateway/gateway_server &
        GATEWAY_PID=$!
        echo "GATEWAY_PID=$GATEWAY_PID" >> $GITHUB_ENV
        sleep 2
    
    - name: Verify processes are running
      run: |
        ps aux | grep matching_engine | grep -v grep
        ps aux | grep gateway_server | grep -v grep
        netstat -tuln | grep 8080
    
    - name: Cleanup
      if: always()
      run: |
        kill ${{ env.ENGINE_PID }} || true
        kill ${{ env.GATEWAY_PID }} || true
        sleep 1
        rm -f /tmp/matching_engine.sock
